- pipeline: "build"
  on: "CLICK"
  refs:
      - "refs/heads/master"
  priority: "NORMAL"
  fail_on_prepare_env_warning: true
  actions:
      - action: "Static analysis / PHP 7.4"
        type: "BUILD"
        working_directory: "/buddy/b2c-demo-shop"
        docker_image_name: "library/php"
        docker_image_tag: "7.4"
        execute_commands:
            - "rm -rf src/Orm/Propel/*"
            - "./config/Shared/ci/ga/prepare_for_validation.sh"
            - "./config/Shared/ci/ga/validate.sh"
        setup_commands:
            - "echo \"memory_limit=-1\" >> /usr/local/etc/php/conf.d/buddy.ini"
            - "apt-get update && apt-get install -y git zip libfontconfig"
            - "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer"
            - ""
            - "# php ext bcmath"
            - "docker-php-ext-configure bcmath --enable-bcmath"
            - "docker-php-ext-install bcmath"
            - ""
            - "# php ext gmp"
            - "apt-get install -y libgmp-dev"
            - "ln -s /usr/include/x86_64-linux-gnu/gmp.h /usr/include/gmp.h"
            - "docker-php-ext-configure gmp --with-gmp"
            - "docker-php-ext-install gmp"
            - ""
            - "# php ext intl"
            - "apt-get install -y libicu-dev"
            - "docker-php-ext-install intl"
            - ""
            - "# php ext pdo_pgsql"
            - "apt-get install -y libpq-dev"
            - "docker-php-ext-configure pdo_pgsql --with-pdo-pgsql"
            - "docker-php-ext-install pdo_pgsql"
            - ""
            - "# php ext redis"
            - "pecl install redis"
            - "docker-php-ext-enable redis"
            - ""
            - "# php ext sockets"
            - "docker-php-ext-configure sockets --enable-sockets"
            - "docker-php-ext-install sockets"
            - ""
            - "# php ext gd"
            - "apt-get install -y libfreetype6-dev"
            - "apt-get install -y libjpeg62-turbo-dev"
            - "apt-get install -y libpng-dev"
            - "docker-php-ext-configure gd --with-freetype --with-jpeg"
            - "docker-php-ext-install gd"
            - ""
            - "# php ext zip"
            - "apt-get install -y zip"
            - "apt-get install -y unzip"
            - "apt-get install -y zlib1g-dev"
            - "apt-get install -y libzip-dev"
            - "docker-php-ext-install zip"
            - ""
            - "# php ext pgsql"
            - "apt-get install -y libpq-dev"
            - "docker-php-ext-configure pgsql --with-pgsql"
            - "docker-php-ext-install pgsql"
            - ""
            - "# php ext bz2"
            - "apt-get install -y libbz2-dev"
            - "docker-php-ext-configure bz2 --with-bz2"
            - "docker-php-ext-install bz2"
            - ""
            - "apt-get install -y postgresql-client npm"
        services:
            - type: "POSTGRE_SQL"
              version: "12"
              connection:
                  host: "postgres"
                  port: 5432
                  user: "postgres"
                  password: "secret"
            - type: "ELASTICSEARCH"
              version: "6.8.0"
              connection:
                  host: "elasticsearch"
                  port: 9200
        volume_mappings:
            - "/:/buddy/b2c-demo-shop"
        cache_base_image: true
        shell: "BASH"
  variables:
      - key: "APPLICATION_ENV"
        value: "ci.pgsql"
        type: "VAR"
      - key: "APPLICATION_STORE"
        value: "DE"
        type: "VAR"
      - key: "DB_PASSWORD"
        value: "secret"
        type: "VAR"
      - key: "OPENSSL_CONF"
        value: "/dev/null"
        type: "VAR"
      - key: "POSTGRES_DB"
        value: "DE_test_zed"
        type: "VAR"
      - key: "POSTGRES_HOST"
        value: "postgres"
        type: "VAR"
      - key: "POSTGRES_PORT"
        value: "5432"
        type: "VAR"
      - key: "POSTGRES_USER"
        value: "postgres"
        type: "VAR"
      - key: "PROJECT"
        value: "suite"
        type: "VAR"
      - key: "SPRYKER_SEARCH_HOST"
        value: "elasticsearch"
        type: "VAR"
      - key: "SPRYKER_SEARCH_PORT"
        value: "9200"
        type: "VAR"
      - key: "SPRYKER_TESTING_ENABLED"
        value: "1"
        type: "VAR"
